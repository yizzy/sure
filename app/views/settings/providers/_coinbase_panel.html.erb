<div id="coinbase-providers-panel" class="space-y-4">
  <% items = local_assigns[:coinbase_items] || @coinbase_items || Current.family.coinbase_items.active.ordered %>

  <div class="prose prose-sm text-secondary">
    <p class="text-primary font-medium"><%= t("settings.providers.coinbase_panel.setup_instructions") %></p>
    <ol>
      <li><%= t("settings.providers.coinbase_panel.step1_html").html_safe %></li>
      <li><%= t("settings.providers.coinbase_panel.step2") %></li>
      <li><%= t("settings.providers.coinbase_panel.step3") %></li>
    </ol>
  </div>

  <% error_msg = local_assigns[:error_message] || @error_message %>
  <% if error_msg.present? %>
    <div class="p-2 rounded-md bg-destructive/10 text-destructive text-sm overflow-hidden">
      <p class="line-clamp-3" title="<%= error_msg %>"><%= error_msg %></p>
    </div>
  <% end %>

  <% if items.any? %>
    <div class="space-y-3">
      <% items.each do |item| %>
        <div class="flex items-center justify-between p-3 bg-container-inset rounded-lg border border-primary">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-[#0052FF] flex items-center justify-center">
              <%= icon "bitcoin", size: "md", class: "text-white" %>
            </div>
            <div>
              <p class="font-medium text-primary"><%= item.name %></p>
              <p class="text-xs text-secondary">
                <% if item.syncing? %>
                  <%= t("settings.providers.coinbase_panel.syncing") %>
                <% else %>
                  <%= item.sync_status_summary %>
                <% end %>
              </p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <%= button_to sync_coinbase_item_path(item),
                          method: :post,
                          class: "inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-secondary hover:text-primary border border-secondary rounded-lg hover:border-primary",
                          disabled: item.syncing? do %>
              <%= icon "refresh-cw", size: "sm" %>
              <%= t("settings.providers.coinbase_panel.sync") %>
            <% end %>
            <%= button_to coinbase_item_path(item),
                          method: :delete,
                          class: "inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-destructive hover:bg-destructive/10 rounded-lg",
                          data: { turbo_confirm: t("settings.providers.coinbase_panel.disconnect_confirm") } do %>
              <%= icon "trash-2", size: "sm" %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <%
      coinbase_item = Current.family.coinbase_items.build(name: "Coinbase")
    %>

    <%= styled_form_with model: coinbase_item,
                         url: coinbase_items_path,
                         scope: :coinbase_item,
                         method: :post,
                         data: { turbo: true },
                         class: "space-y-3" do |form| %>
      <%= form.text_field :api_key,
                          label: t("settings.providers.coinbase_panel.api_key_label"),
                          placeholder: t("settings.providers.coinbase_panel.api_key_placeholder"),
                          type: :password %>

      <%= form.text_field :api_secret,
                          label: t("settings.providers.coinbase_panel.api_secret_label"),
                          placeholder: t("settings.providers.coinbase_panel.api_secret_placeholder"),
                          type: :password %>

      <div class="flex justify-end">
        <%= form.submit t("settings.providers.coinbase_panel.connect_button"),
                        class: "inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-medium text-inverse bg-inverse hover:bg-inverse-hover focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-2 transition-colors" %>
      </div>
    <% end %>
  <% end %>

  <div class="flex items-center gap-2">
    <% if items.any? %>
      <div class="w-2 h-2 bg-success rounded-full"></div>
      <p class="text-sm text-secondary"><%= t("settings.providers.coinbase_panel.status_connected") %></p>
    <% else %>
      <div class="w-2 h-2 bg-tertiary rounded-full"></div>
      <p class="text-sm text-secondary"><%= t("settings.providers.coinbase_panel.status_not_connected") %></p>
    <% end %>
  </div>
</div>
