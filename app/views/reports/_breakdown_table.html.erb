<%# Renders a breakdown table for income or expense groups %>
<%# Local variables: groups, total, type (:income or :expense), amount_sort_params, current_sort_by, current_sort_direction %>

<%
  color_class = type == :income ? "text-success" : "text-destructive"
  icon_name = type == :income ? "trending-up" : "trending-down"
  title_key = type == :income ? "reports.transactions_breakdown.table.income" : "reports.transactions_breakdown.table.expense"
%>

<div>
  <h3 class="text-base font-semibold <%= color_class %> mb-4 flex items-center gap-2">
    <%= icon(icon_name, class: "w-5 h-5") %>
    <%= t(title_key) %>
    <span class="text-sm font-normal text-tertiary">(<%= Money.new(total, Current.family.currency).format %>)</span>
  </h3>

  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-tertiary">
          <th class="text-left py-3 pr-4 font-medium text-secondary"><%= t("reports.transactions_breakdown.table.category") %></th>
          <th class="text-right py-3 px-4 font-medium text-secondary">
            <%= link_to reports_path(amount_sort_params), class: "inline-flex items-center gap-1 hover:text-primary" do %>
              <%= t("reports.transactions_breakdown.table.amount") %>
              <% if current_sort_by == "amount" %>
                <%= icon(current_sort_direction == "desc" ? "chevron-down" : "chevron-up", class: "w-3 h-3") %>
              <% end %>
            <% end %>
          </th>
          <th class="text-right py-3 pl-4 font-medium text-secondary"><%= t("reports.transactions_breakdown.table.percentage") %></th>
        </tr>
      </thead>
      <tbody>
        <% groups.each do |group| %>
          <% percentage = total.zero? ? 0 : (group[:total].to_f / total * 100).round(1) %>
          <% has_subcategories = group[:subcategories].present? && group[:subcategories].any? %>
          <tr class="border-b border-tertiary hover:bg-surface-inset">
            <td class="py-3 pr-4">
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: <%= group[:category_color] %>"></span>
                <span class="font-medium text-primary"><%= group[:category_name] %></span>
                <span class="text-xs text-tertiary whitespace-nowrap">(<%= t("reports.transactions_breakdown.table.entries", count: group[:count]) %>)</span>
              </div>
            </td>
            <td class="py-3 px-4 text-right">
              <span class="font-semibold <%= color_class %>">
                <%= Money.new(group[:total], Current.family.currency).format %>
              </span>
            </td>
            <td class="py-3 pl-4 text-right">
              <span class="text-sm text-secondary">
                <%= percentage %>%
              </span>
            </td>
          </tr>
          <%# Render subcategories if present %>
          <% if has_subcategories %>
            <% group[:subcategories].each do |subcategory| %>
              <% sub_percentage = total.zero? ? 0 : (subcategory[:total].to_f / total * 100).round(1) %>
              <tr class="border-b border-tertiary hover:bg-surface-inset bg-surface-inset/30">
                <td class="py-2 pr-4 pl-6">
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full flex-shrink-0" style="background-color: <%= subcategory[:category_color] %>"></span>
                    <span class="text-sm text-secondary"><%= subcategory[:category_name] %></span>
                    <span class="text-xs text-tertiary whitespace-nowrap">(<%= t("reports.transactions_breakdown.table.entries", count: subcategory[:count]) %>)</span>
                  </div>
                </td>
                <td class="py-2 px-4 text-right">
                  <span class="text-sm <%= color_class %>">
                    <%= Money.new(subcategory[:total], Current.family.currency).format %>
                  </span>
                </td>
                <td class="py-2 pl-4 text-right">
                  <span class="text-xs text-tertiary">
                    <%= sub_percentage %>%
                  </span>
                </td>
              </tr>
            <% end %>
          <% end %>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
